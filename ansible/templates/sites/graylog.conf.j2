<VirtualHost *:80>
    ServerName {{ graylog_hostname }}

    # Enable rewrite engine
    RewriteEngine On

    # Exclude ACME challenge path from redirect
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/ [NC]
    
    # Redirect everything else to HTTPS
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

    # Optional: serve ACME challenge normally
    DocumentRoot /var/www/html

    <Directory /var/www/html>
        Require all granted
    </Directory>
</VirtualHost>
<VirtualHost *:443>
    ServerName {{ graylog_hostname }}
    FallbackResource /index.html

    ProxyPreserveHost Off
    ProxyPass        / http://localhost:9000/
    ProxyPassReverse / http://localhost:9000/
 
    SSLEngine on

    SSLCertificateFile /etc/letsencrypt/live/{{ graylog_hostname }}/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/{{ graylog_hostname }}/privkey.pem

    # Optional but recommended hardening
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder off
</VirtualHost>
